# Reusable workflow for daily nanoda verification
# Users can call this workflow from their repository:
#
#   name: Daily nanoda verification
#   on:
#     schedule:
#       - cron: '0 0 * * *'
#     workflow_dispatch:
#   jobs:
#     verify:
#       uses: leanprover/lean-action/.github/workflows/nanoda-daily.yml@v1
#       secrets:
#         webhook-url: ${{ secrets.WEBHOOK_URL }}      # optional
#         zulip-api-key: ${{ secrets.ZULIP_API_KEY }}  # optional

name: nanoda Daily Verification

on:
  workflow_call:
    inputs:
      allow-sorry:
        description: 'Permit sorryAx axiom'
        type: boolean
        default: true
      notify:
        description: 'Notification method: issue, webhook, zulip, none'
        type: string
        default: 'issue'
      zulip-stream:
        description: 'Zulip stream name (if using zulip notify)'
        type: string
        default: 'ci'
      zulip-topic:
        description: 'Zulip topic (if using zulip notify)'
        type: string
        default: 'nanoda'
      zulip-org-url:
        description: 'Zulip organization URL (required if using zulip notify)'
        type: string
        default: ''
    secrets:
      webhook-url:
        description: 'Slack/Discord webhook URL (optional)'
        required: false
      zulip-api-key:
        description: 'Zulip bot API key (optional)'
        required: false

jobs:
  nanoda-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run lean-action with nanoda
        id: lean-action
        uses: leanprover/lean-action@v1
        with:
          nanoda: true
          nanoda-allow-sorry: ${{ inputs.allow-sorry }}
          nanoda-on-main-only: false  # This workflow is already scheduled, so run always

      - name: Create GitHub issue on failure
        if: failure() && inputs.notify == 'issue'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '❌ Daily nanoda verification failed',
              body: `The daily nanoda type checker verification failed.\n\n**Commit:** ${context.sha}\n**Run:** [View workflow run](${runUrl})\n\nPlease investigate and fix any type checking issues.`,
              labels: ['nanoda', 'automated', 'ci-failure']
            });

      - name: Send webhook notification
        if: always() && inputs.notify == 'webhook' && secrets.webhook-url != ''
        run: |
          STATUS="${{ job.status }}"
          EMOJI=$([[ "$STATUS" == "success" ]] && echo "✅" || echo "❌")
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "${{ secrets.webhook-url }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"$EMOJI nanoda daily verification: $STATUS\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$EMOJI *nanoda daily verification*: $STATUS\n<$RUN_URL|View run> | Commit: \`${{ github.sha }}\`\"
                  }
                }
              ]
            }"
        shell: bash

      - name: Send Zulip notification on success
        if: success() && inputs.notify == 'zulip' && secrets.zulip-api-key != ''
        uses: zulip/github-actions-zulip/send-message@e4c8f27c732ba9bd98ac6be0583096dea82feea5
        with:
          api-key: ${{ secrets.zulip-api-key }}
          email: 'github-bot@${{ inputs.zulip-org-url }}'
          organization-url: 'https://${{ inputs.zulip-org-url }}'
          to: ${{ inputs.zulip-stream }}
          type: 'stream'
          topic: ${{ inputs.zulip-topic }}
          content: |
            ✅ nanoda daily verification [succeeded](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) on `${{ github.sha }}`

      - name: Send Zulip notification on failure
        if: failure() && inputs.notify == 'zulip' && secrets.zulip-api-key != ''
        uses: zulip/github-actions-zulip/send-message@e4c8f27c732ba9bd98ac6be0583096dea82feea5
        with:
          api-key: ${{ secrets.zulip-api-key }}
          email: 'github-bot@${{ inputs.zulip-org-url }}'
          organization-url: 'https://${{ inputs.zulip-org-url }}'
          to: ${{ inputs.zulip-stream }}
          type: 'stream'
          topic: '${{ inputs.zulip-topic }} failure'
          content: |
            ❌ nanoda daily verification [failed](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) on `${{ github.sha }}`
